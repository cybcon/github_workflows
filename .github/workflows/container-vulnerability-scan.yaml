name: Container vulnerability scan
on:
  workflow_call:
    inputs:
      image_name:
        type: string
        description: Container image name and tag to scan
        required: true
      image_artifact_name:
        type: string
        description: Container image artifact name to identify the container image file from artifacts
        required: false
      image_artifact_filename:
        type: string
        description: Container image file that needs to be downloaded from artifacts
        required: false
      login_dockerhub:
        type: boolean
        description: "Login to DockerHub, requires the secrets DOCKERHUB_USERNAME and DOCKERHUB_PASSWORD (default: false)"
        required: false
        default: false
      trivy_tag:
        type: string
        description: "Use a special aquasec/trivy container image tag (default: latest)"
        required: false
        default: latest
    secrets:
      DOCKERHUB_USERNAME:
        description: "The username to login to Docker Registry."
        required: false
      DOCKERHUB_PASSWORD:
        description: "The password to login to Docker Registry."
        required: false
jobs:
  vulnerability-scan:
    name: Container vulnerability scan
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to DockerHub container registry
        if: ${{ inputs.login_dockerhub }} == true
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Pull aquasec/trivy
        run: |
          docker pull aquasec/trivy:${{ inputs.trivy_tag }}
      - name: Download container image from artifacts if uploaded
        if: ${{ inputs.image_artifact_name }} != null &&
            ${{ inputs.image_artifact_filename }} != null
        uses: actions/download-artifact@v2
        with:
          name: ${{ inputs.image_artifact_name }}
          path: /tmp
      - name: Load container image file if one is shipped via artifacts
        if: ${{ inputs.image_artifact_name }} != null &&
            ${{ inputs.image_artifact_filename }} != null
        run: |
          docker load --input /tmp/${{ inputs.image_artifact_filename }}
          RC=$?
          if [ ${RC} -gt 0 ]; then
            exit ${RC}
          fi
      - name: Pull container image that should be scanned if no container image is shipped via artifacts
        if: ${{ inputs.image_artifact_name }} == null &&
            ${{ inputs.image_artifact_filename }} == null
        run: |
          docker pull ${{ inputs.image_name }}
          RC=$?
          if [ ${RC} -gt 0 ]; then
            exit ${RC}
          fi
      - name: List available container images in local repository
        run: |
          docker image ls -a
      - name: Vulnerability scan
        run: |
          docker run -u 0 --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:${{ inputs.trivy_tag }} -q image ${{ inputs.image_name }} >> ${GITHUB_STEP_SUMMARY} 2>&1
